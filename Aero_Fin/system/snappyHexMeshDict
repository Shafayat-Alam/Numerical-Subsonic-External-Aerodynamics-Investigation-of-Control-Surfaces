FoamFile
{
    version     2.0;
    format      ascii;
    class       dictionary;
    object      snappyHexMeshDict;
}

castellatedMesh true;
snap            true;
addLayers       true;

geometry
{
    Fin.stl  
    {
        type triSurfaceMesh;
        name Fin; 
    }
}

castellatedMeshControls
{
    maxLocalCells 1000000;
    maxGlobalCells 4000000; 
    minRefinementCells 10;
    nCellsBetweenLevels  2;

    features 
    (
        {
            file  "Fin.eMesh";
            level 7;            
        }
    );

    refinementSurfaces
    {
        Fin
        {
            level (7 7);        
            patchInfo { type wall; }
        }
    }

    refinementRegions
    {
        Fin
        {
            mode distance;
            levels
            (
                (0.001 7) // Level 7 only within 1mm (Tight boundary layer)
                (0.003 6) // Level 6 within 3mm (Captures the wake near the fin)
                (0.010 4) // Level 4 out to 1cm (Transition to base mesh)
            );
        }
    }

    resolveFeatureAngle 60;
    mergeTolerance 1e-4; 
    allowFreeStandingZoneFaces true;
    locationInMesh (-0.5 0 0.4);  
}

snapControls
{
    nSmoothPatch    10;     
    tolerance       2.0;    
    nSolveIter      60;     
    nRelaxIter      10;     
    nFeatureSnapIter 20;    
    implicitFeatureSnap false; 
    explicitFeatureSnap true; 
    multiRegionFeatureSnap true;

    //nSmoothPatch 1;
    //nSnapIter 1;
    //nFeatureSnapIter 1;
}

addLayersControls
{
    relativeSizes true;

    layers
    {
        Fin
        {
            nSurfaceLayers 8;
        }
    }

    expansionRatio               1.2;
    finalLayerThickness          0.30;   
    minThickness                 0.08;   

    nGrow                         0;     
    featureAngle                 120;    
    slipFeatureAngle             30;

    nRelaxIter                    5;
    nSmoothSurfaceNormals        10;
    nSmoothNormals                5;
    nSmoothThickness              8;
    nBufferCellsNoExtrude 0;

    maxFaceThicknessRatio         0.5;

    minMedialAxisAngle          90; 
    maxThicknessToMedialRatio   0.3;

    nLayerIter                   50;
    nRelaxedIter                 20;
}

meshQualityControls
{
    maxNonOrtho         70;      
    maxBoundarySkewness  8;      
    maxInternalSkewness  4;      
    maxConcave          80;      

    minArea         1e-13;       
    minVol          1e-18;       
    minTwist        0.02;        
    minFaceWeight   0.05;        
    minVolRatio     0.02;        

    minTetQuality   1e-12;       
    minTriangleTwist 0.02;       
    minDeterminant  0.001;       

    errorReduction  0.75;        
    nSmoothScale    10;          
}

mergeTolerance 1e-6;
debug 0;